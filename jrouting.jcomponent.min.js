(function(c){var v={};var h='NAV.';var d={cache:{},version:7,errors:[],global:{},hashtags:false,middlewares:{},model:null,params:[],query:{},repository:{},routes:[],url:'',count:0};var g={$prev:[],$next:[],isReady:false,LIMIT_HISTORY:100,LIMIT_HISTORY_ERROR:100};d.history=g.$prev;var s=location;!c.NAVIGATION&&(c.NAVIGATION=d);!c.NAV&&(c.NAV=d);!c.jR&&(c.jR=d);d.custom=function(){d.$custom=true;CACHEPATH('NAV.url','1 month')};d.remove=function(r){r=r.env(true).ROOT(true);var e=[];for(var t=0;t<d.routes.length;t++)d.routes[t].id!==r&&e.push(d.routes[t]);d.routes=e;return d};d.on=function(r,e){ON(r,e);return d};d.emit=function(){EMIT.apply(c,arguments)};d.autosave=function(){d.$save=1};d.save=function(){try{localStorage.setItem(MAIN.$localstorage+'.nav',STRINGIFY({prev:g.$prev,next:g.$next,ts:new Date}))}catch(r){}};d.load=function(){try{var r=PARSE(localStorage.getItem(MAIN.$localstorage+'.nav')||'null');if(r){if(r.prev instanceof Array)g.$prev=d.history=r.prev;if(r.next instanceof Array)g.$next=r.next;d.$pop=true}}catch(r){}};d.route=function(r,e,t,n){var a;if(e instanceof Array){var a=t;t=e;e=a}if(typeof t==='function'){a=n;n=t;t=a}r=r.env(true).ROOT(true);var i=r.jRcount('/')+(r.indexOf('*')===-1?0:10);var u=d._route(r.trim());var o=[];if(typeof t==='string')t=t.split(',').trim();var s=[];var l=[];var f={};t instanceof Array&&t.forEach(function(r){if(typeof r==='object')f=r;else if(r.substring(0,1)==='@')l.push(r.substring(1));else s.push(r)});if(r.indexOf('{')!==-1){i-=100;for(var p=0;p<u.length;p++)u[p].substring(0,1)==='{'&&o.push(p);i-=o.length}d.remove(r);d.routes.push({id:r,url:u,fn:e,priority:i,params:o,middleware:s.length?s:null,init:n,count:0,pending:false,options:f,roles:l});d.routes.sort(function(r,e){return r.priority>e.priority?-1:r.priority<e.priority?1:0});d.is404&&r===d.url&&c.REDIRECT(r+(d.queryraw?'?'+d.queryraw:''));d.emit('route',r);return d};c.MIDDLEWARE=d.middleware=function(r,e){if(r instanceof Array){r.wait(function(r,e){var t=d.middlewares[r];if(t)t(e);else e()},e);return d}d.middlewares[r]=e;return d};d.refresh=function(){return d.location(d.url,true)};d.reload=function(){return d.refresh()};d._route=function(r){if(r.charCodeAt(0)===47)r=r.substring(1);if(r.charCodeAt(r.length-1)===47)r=r.substring(0,r.length-1);var e=r.split('/');if(e.length===1&&!e[0])e[0]='/';return e};d._route_param=function(r,e){var t=[];if(!e||!r)return t;var n=e.params.length;if(n){for(var a=0;a<n;a++){var i=r[e.params[a]];t.push(i==='/'?'':i)}}return t};d._route_compare=function(r,e){var t=r.length;var n=t===1&&r[0]==='/';if(e.length!==t)return false;for(var a=0;a<t;a++){var i=e[a];if(!i)return false;if(!n&&i.charCodeAt(0)===123)continue;if(i==='*')return true;if(r[a]!==i)return false}return true};d.location=function(r,e){if(!g.isReady)return;var t=r.indexOf('?');if(t!==-1)r=r.substring(0,t);r=v.prepareUrl(r);r=v.path(r);var n=d._route(r);var a=[];var i=true;var u=[];u.push.apply(u,n);for(var o=0;o<n.length;o++)n[o]=n[o].toLowerCase();if(!e&&d.url.length&&d.prev()!==d.url){if(d.$pop)d.$pop=false;else{g.$prev.push(d.url);g.$prev.length>d.LIMIT_HISTORY&&g.$prev.shift();g.$next.length>d.LIMIT_HISTORY&&g.$next.shift();d.$save&&d.save()}}if(d.isback!==g.$prev.length)SET(h+'isback',g.$prev.length);if(d.isforward!==g.$next.length)SET(h+'isforward',g.$next.length);for(var o=0;o<d.routes.length;o++){var s=d.routes[o];if(!d._route_compare(n,s.url))continue;if(s.url.indexOf('*')===-1)i=false;if(s.once&&s.count>0)continue;s.count++;a.push(s);break}var l=false;var f=[];if(d.url.length)d.cache[d.url]=d.repository;var p=d.url;d.url=r;if(d.url!==p)UPD(h+'url');d.repository=d.cache[r];UPD(h+'repository');if(!d.repository)d.repository={};d._params();d.params=d._route_param(u,s);UPD(h+'params');d.is404=false;d.emit('location',r);for(var o=0;o<a.length;o++){var s=a[o];if(s.pending)continue;if(!s.middleware||!s.middleware.length){if(!s.init){s.fn.apply(d,d.params);continue}s.pending=true;(function(r){r.init(function(){r.fn.apply(d,d.params);r.pending=false})})(s);s.init=null;continue}(function(e){var r=e.middleware.length;var n=[];for(var t=0;t<r;t++){var a=d.middlewares[e.middleware[t]];a&&function(e,t){n.push(function(r){t.call(d,r,e.options,e.roles,e)})}(e,a)}if(!e.init){e.pending=true;n.jRmiddleware(function(r){!r&&e.fn.apply(d,d.params);e.pending=false},e);return}e.pending=true;e.init(function(){n.jRmiddleware(function(r){!r&&e.fn.apply(d,d.params);e.pending=false},e)});e.init=null})(s)}l&&d.status(500,f);if(i){d.is404=true;d.status(404)}else d.is404=false};d.prev=function(){return g.$prev[g.$prev.length-1]};d.next=function(){return g.$next[g.$next.length-1]};d.back=function(r){var e=g.$prev.pop()||'/';if(d.url&&d.next()!==d.url)g.$next.push(d.url);d.url='';c.REDIRECT(e,r);d.$save&&d.save();return d};d.forward=function(r){var e=g.$next.pop()||'/';if(d.url&&d.prev()!==d.url)g.$prev.push(d.url);d.url='';c.REDIRECT(e,r);d.$save&&d.save();return d};d.status=function(r,e){EMIT(r+'',e);return d};c.REDIRECT=NAV.redirect=function(r,e){if(!r)r=d.url;r=r.env(true).ROOT(true);var t=r.charCodeAt(0);var n=s;if(t===35){d.model=e||null;n.hash=r;d.location(r,false)}else if(d.$custom){d.model=e||null;d.location(r,false)}else if(history.pushState){history.pushState(null,null,r);d.model=e||null;d.location(n.pathname+n.search,false)}else n.href=r};d._params=function(){var r={};d.queryraw=s.search.substring(1);var e=d.queryraw.split('&');for(var t=0;t<e.length;t++){var n=e[t].replace(/\+/g,'%20').split('=');if(n.length!==2)continue;var a=decodeURIComponent(n[0]);var i=decodeURIComponent(n[1]);var u=r[a]instanceof Array;if(r[a]&&!u)r[a]=[r[a]];if(u)r[a].push(i);else r[a]=i}d.query=r;var o=h+'query';c.M&&UPD(o);return d};d.path=v.path=function(r,e){if(r.substring(0,1)==='#')return r;if(!e)e='/';var t=r.indexOf('?');var n='';if(t!==-1){n=r.substring(t);r=r.substring(0,t)}var a=r.length;var i=r.substring(a-1,a);if(i!==e)r+=e;return r+n};v.prepareUrl=function(r){if(r.substring(0,1)==='#')return r;var e=r.indexOf('#');return e!==-1?r.substring(0,e):r};Array.prototype.jRmiddleware=function(e,t){var n=this;var r=n.shift();if(r===undefined){e&&e();return n}r(function(r){if(r instanceof Error||r===false)e&&e(r===false?true:r);else setTimeout(function(){n.jRmiddleware(e,t)},1)},t.options,t.roles);return n};String.prototype.jRcount=function(r){var e=0;var t=0;do{e=this.indexOf(r,e+r.length);if(e>0)t++}while(e>0);return t};d.clientside=function(r){$(document).on('click',r,function(r){r.preventDefault();var e=$(this);var t=e.attr('href')||e.attrd('href')||e.attrd('url');t!=='javas'+'cript:vo'+'id(0)'&&t!=='#'&&c.REDIRECT(t)});return d};function r(){$(document).ready(function(){if(!d.$custom){if(d.hashtags)d.url=s.hash||v.path(v.prepareUrl(s.pathname));else d.url=v.path(v.prepareUrl(s.pathname))}setTimeout(function(){g.isReady=true;d.location(d.url)},5);$(c).on('hashchange',function(){g.isReady&&d.hashtags&&d.location(v.path(s.hash))}).on('popstate',function(){if(g.isReady&&!d.hashtags&&!d.$custom){var r=v.path(s.pathname);d.url!==r&&d.location(r)}})})}if(c.jQuery&&c.MAIN&&c.MAIN.loaded){r()}else{d.init=setInterval(function(){if(c.jQuery&&c.MAIN&&c.MAIN.loaded){clearInterval(d.init);r()}},100)}d._params();c.ROUTE=function(r,e,t,n){return d.route(r,e,t,n)}})(window);